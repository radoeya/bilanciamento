<!DOCTYPE html>
<html lang="it">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Dashboard Analisi e Gestione Personale</title>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary-color: #0d47a1;
Â  Â  Â  Â  Â  Â  --secondary-color: #1e88e5;
Â  Â  Â  Â  Â  Â  --accent-color: #5c6bc0;
Â  Â  Â  Â  Â  Â  --success-color: #28a745;Â 
Â  Â  Â  Â  Â  Â  --danger-color: #dc3545;
Â  Â  Â  Â  Â  Â  --info-color: #17a2b8;
Â  Â  Â  Â  Â  Â  --light-gray: #f4f7f6;
Â  Â  Â  Â  Â  Â  --dark-gray: #333;
Â  Â  Â  Â  Â  Â  --white-color: #ffffff;
Â  Â  Â  Â  Â  Â  --border-color: #ddd;
Â  Â  Â  Â  }
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
Â  Â  Â  Â  Â  Â  margin: 0; padding: 2rem; background-color: var(--light-gray); color: var(--dark-gray);
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  h1, h2, h3, h4, h5 { color: var(--primary-color); font-weight: 600; }
Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  background: var(--white-color); padding: 2rem; border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); width: 95%; max-width: 1400px; margin-bottom: 2rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  #controls {
Â  Â  Â  Â  Â  Â  display: flex; gap: 1.5rem; align-items: center; margin-bottom: 1rem;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  #averageDisplay {
Â  Â  Â  Â  Â  Â  margin-left: auto; padding: 0.7rem 1rem; background-color: #eef7ff;
Â  Â  Â  Â  Â  Â  border: 2px solid var(--info-color); border-radius: 8px; font-size: 16px;
Â  Â  Â  Â  Â  Â  font-weight: 500; color: var(--primary-color); display: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  input, select, button, textarea {
Â  Â  Â  Â  Â  Â  font-size: 16px; padding: 0.7rem 1rem; border-radius: 8px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc; font-family: inherit; transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  input[type="file"]::file-selector-button {
Â  Â  Â  Â  Â  Â  background-color: var(--secondary-color); color: var(--white-color); border: none;
Â  Â  Â  Â  Â  Â  padding: 0.7rem 1rem; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  input[type="file"]::file-selector-button:hover { background-color: var(--primary-color); }
Â  Â  Â  Â  button { background-color: var(--secondary-color); color: var(--white-color); border: none; cursor: pointer; }
Â  Â  Â  Â  button:hover { background-color: var(--primary-color); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
Â  Â  Â  Â  button.danger { background-color: var(--danger-color); }
Â  Â  Â  Â  button.danger:hover { background-color: #a8001b; }
Â  Â  Â  Â  button:disabled { background-color: #9e9e9e; cursor: not-allowed; transform: none; box-shadow: none; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #dashboard { display: flex; flex-direction: column; gap: 2rem; width: 100%; margin-top: 1rem; }
Â  Â  Â  Â  #chartContainer { height: 400px; width: 100%; }
Â  Â  Â  Â  #calendarsWrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
Â  Â  Â  Â  .calendar-container { height: 480px; }
Â  Â  Â  Â  .calendar-container h3 { text-align: center; margin-top: 0; margin-bottom: 10px; }
Â  Â  Â  Â  .calendar-instance { height: calc(100% - 30px); }

Â  Â  Â  Â  #balancingResults, #swapResults { margin-top: 2rem; padding: 1.5rem; background-color: #e3f2fd; border-left: 6px solid var(--secondary-color); border-radius: 8px; }
Â  Â  Â  Â  #balancingResults ul, #swapResults ul { list-style-type: none; padding-left: 0; }
Â  Â  Â  Â  #balancingResults li, #swapResults li { padding: 12px; border-radius: 6px; margin-bottom: 8px; transition: background-color 0.2s, transform 0.2s; border: 1px solid #90caf9; }
Â  Â  Â  Â  #balancingResults li { cursor: pointer; }
Â  Â  Â  Â  #balancingResults li:hover { background-color: #bbdefb; transform: scale(1.01); }
Â  Â  Â  Â  #swapResults li { display: flex; justify-content: space-between; align-items: center; }

Â  Â  Â  Â  #swapHelper { border: 2px solid var(--accent-color); padding: 1.5rem; border-radius: 8px; scroll-margin-top: 20px; }
Â  Â  Â  Â  .proposal-block {
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding: 1.5rem;
Â  Â  Â  Â  Â  Â  margin-top: 1.5rem;
Â  Â  Â  Â  Â  Â  background-color: #fafafa;
Â  Â  Â  Â  }
Â  Â  Â  Â  .proposal-header { display: flex; justify-content: space-between; align-items: center; }
Â  Â  Â  Â  .swap-area { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem; }
Â  Â  Â  Â  .swap-area-col label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
Â  Â  Â  Â  .swap-area-col input[type="date"], .swap-area-col textarea { width: calc(100% - 2.2rem); margin-bottom: 0.5rem; }
Â  Â  Â  Â  .swap-area-col textarea { height: 150px; resize: vertical; }
Â  Â  Â  Â  .swap-area-col button { width: 100%; margin-top: 0.5rem; }
Â  Â  Â  Â  .parsed-list-container { border: 1px solid var(--border-color); margin-top: 1rem; padding: 0.5rem 1rem; border-radius: 5px; background-color: #fff; max-height: 200px; overflow-y: auto; }
Â  Â  Â  Â  .parsed-list-container h5 { margin: 10px 0 5px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; }
Â  Â  Â  Â  .parsed-list-container ul { list-style-type: none; padding-left: 5px; margin-top: 5px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #tableContainer { margin-top: 2.5rem; width: 100%; overflow-x: auto; }
Â  Â  Â  Â  #dataTable { width: 100%; border-collapse: collapse; font-size: 14px; }
Â  Â  Â  Â  #dataTable caption { caption-side: bottom; text-align: right; font-size: 12px; color: #666; padding-top: 10px; }
Â  Â  Â  Â  #dataTable th, #dataTable td { border: 1px solid var(--border-color); padding: 10px; text-align: left; white-space: nowrap; }
Â  Â  Â  Â  hr { border: none; border-top: 1px solid #ccc; margin: 2rem 0; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 1200px) { #calendarsWrapper { grid-template-columns: 1fr; } .swap-area { grid-template-columns: 1fr; } }
Â  Â  </style>
</head>
<body>

Â  Â  <div class="container">
Â  Â  Â  Â  <h1>Dashboard Analisi Personale ğŸ“Š</h1>
Â  Â  Â  Â  <div id="controls">
Â  Â  Â  Â  Â  Â  <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" onchange="handleFile()">
Â  Â  Â  Â  Â  Â  <label for="rowSelector">Scegli una voce da analizzare:</label>
Â  Â  Â  Â  Â  Â  <select id="rowSelector" onchange="plotSelectedData()" disabled></select>
Â  Â  Â  Â  Â  Â  <button id="balanceBtn" onclick="balancePersonnel()" disabled>Suggerisci Bilanciamento</button>
Â  Â  Â  Â  Â  Â  <div id="averageDisplay"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="dashboard" style="display: none;">
Â  Â  Â  Â  Â  Â  <div id="chartContainer"><canvas id="myChart"></canvas></div>
Â  Â  Â  Â  Â  Â  <div id="calendarsWrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="calendar-container" id="originalCalendarContainer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="originalCalendarTitle"></h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="calendarOriginal" class="calendar-instance"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="calendar-container" id="balancedCalendarContainer" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="balancedCalendarTitle"></h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="calendarBalanced" class="calendar-instance"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="balancingResults" style="display: none;"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="container" id="swapHelper">
Â  Â  Â  Â  <h2>Assistente Scambio Turni ğŸ› ï¸</h2>
Â  Â  Â  Â  <p>Aggiungi una o piÃ¹ proposte di scambio usando il pulsante qui sotto. Puoi pre-compilare le date cliccando sui suggerimenti di bilanciamento.</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="proposals-container">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button onclick="addProposalBlock()" style="margin-top: 1.5rem;">+ Aggiungi Proposta di Scambio</button>
Â  Â  Â  Â  <hr>
Â  Â  Â  Â  <button id="findCommonBtn" onclick="findAllSwapsAndGenerateEmails()" style="width: 100%; padding: 1rem; font-size: 1.1rem;" >Analizza TUTTE le proposte e Trova Collaboratori Comuni</button>
Â  Â  Â  Â  <div id="swapResults" style="display: none;"></div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="container" id="tableContainer" style="display: none;">
Â  Â  Â  Â  <h2>Dettaglio Dati Importati</h2>
Â  Â  Â  Â  <table id="dataTable"></table>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- Variabili Globali ---
Â  Â  Â  Â  let myChart = null, calendarOriginal = null, calendarBalanced = null;
Â  Â  Â  Â  let jsonData = [], headers = [], originalData = {};
Â  Â  Â  Â  let proposals = []; // MODIFICA: Array per contenere tutte le proposte
Â  Â  Â  Â  let proposalCounter = 0; // MODIFICA: Contatore per ID unici delle proposte
Â  Â  Â  Â  const displayLimit = 200;

Â  Â  Â  Â  // --- Funzioni di UtilitÃ  e Caricamento ---
Â  Â  Â  Â  function convertDateToISO(dateStr) {
Â  Â  Â  Â  Â  Â  const parts = String(dateStr).split('.');
Â  Â  Â  Â  Â  Â  if (parts.length !== 3) return null;
Â  Â  Â  Â  Â  Â  return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleFile() {
Â  Â  Â  Â  Â  Â  const fileInput = document.getElementById('excelFile');
Â  Â  Â  Â  Â  Â  if (!fileInput.files[0]) return;
Â  Â  Â  Â  Â  Â  const data = await fileInput.files[0].arrayBuffer();
Â  Â  Â  Â  Â  Â  const workbook = XLSX.read(data);
Â  Â  Â  Â  Â  Â  const worksheet = workbook.Sheets[workbook.SheetNames[0]];
Â  Â  Â  Â  Â  Â  const matrix = XLSX.utils.sheet_to_json(worksheet, { header: 1, skipHidden: true, defval: 0 });
Â  Â  Â  Â  Â  Â  let headerRowIndex = matrix.findIndex(row => row.length > 2);
Â  Â  Â  Â  Â  Â  if (headerRowIndex === -1) { alert("Intestazione non trovata."); return; }
Â  Â  Â  Â  Â  Â  const headerRow = matrix[headerRowIndex];
Â  Â  Â  Â  Â  Â  headers = headerRow.filter(h => h);
Â  Â  Â  Â  Â  Â  jsonData = matrix.slice(headerRowIndex + 1).map(row => {
Â  Â  Â  Â  Â  Â  Â  Â  const obj = {};
Â  Â  Â  Â  Â  Â  Â  Â  headers.forEach((header, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rawValue = row[index];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let cleanValue = (typeof rawValue === 'number' || (typeof rawValue === 'string' && rawValue.trim() !== '')) ? parseFloat(rawValue) : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(cleanValue) || cleanValue < 0) cleanValue = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  obj[header] = index === 0 ? rawValue : cleanValue;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return obj;
Â  Â  Â  Â  Â  Â  }).filter(obj => obj[headers[0]]);
Â  Â  Â  Â  Â  Â  const selector = document.getElementById('rowSelector');
Â  Â  Â  Â  Â  Â  selector.innerHTML = '<option value="">-- Seleziona --</option>';
Â  Â  Â  Â  Â  Â  jsonData.slice(0, displayLimit).forEach((row, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  selector.appendChild(new Option(row[headers[0]], index));
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (jsonData.length > displayLimit) {
Â  Â  Â  Â  Â  Â  Â  Â  const option = new Option(`E ${jsonData.length - displayLimit} altre voci non mostrate...`, '');
Â  Â  Â  Â  Â  Â  Â  Â  option.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  selector.appendChild(option);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  selector.disabled = false;
Â  Â  Â  Â  Â  Â  document.getElementById('balanceBtn').disabled = true;
Â  Â  Â  Â  Â  Â  document.getElementById('tableContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.getElementById('dashboard').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('balancingResults').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('averageDisplay').style.display = 'none';
Â  Â  Â  Â  Â  Â  if (myChart) myChart.destroy();
Â  Â  Â  Â  Â  Â  if (calendarOriginal) calendarOriginal.destroy();
Â  Â  Â  Â  Â  Â  if (calendarBalanced) calendarBalanced.destroy();
Â  Â  Â  Â  Â  Â  displayTable();
Â  Â  Â  Â  }

Â  Â  Â  Â  function displayTable() {
Â  Â  Â  Â  Â  Â  const table = document.getElementById('dataTable');
Â  Â  Â  Â  Â  Â  table.innerHTML = '';
Â  Â  Â  Â  Â  Â  const thead = table.createTHead().insertRow();
Â  Â  Â  Â  Â  Â  headers.forEach(text => thead.appendChild(document.createElement('th')).textContent = text);
Â  Â  Â  Â  Â  Â  const tbody = table.createTBody();
Â  Â  Â  Â  Â  Â  jsonData.slice(0, displayLimit).forEach(dataRow => {
Â  Â  Â  Â  Â  Â  Â  Â  const row = tbody.insertRow();
Â  Â  Â  Â  Â  Â  Â  Â  headers.forEach(header => row.insertCell().textContent = dataRow[header] !== undefined ? dataRow[header] : '');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (jsonData.length > displayLimit) {
Â  Â  Â  Â  Â  Â  Â  Â  const caption = table.createCaption();
Â  Â  Â  Â  Â  Â  Â  Â  caption.textContent = `Mostrando un'anteprima delle prime ${displayLimit} righe. Tutti i dati sono caricati per le analisi.`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Funzioni Grafici e Calendari ---
Â  Â  Â  Â  function plotSelectedData() {
Â  Â  Â  Â  Â  Â  const selector = document.getElementById('rowSelector');
Â  Â  Â  Â  Â  Â  if (!selector.value) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('dashboard').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('averageDisplay').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('balanceBtn').disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('dashboard').style.display = 'flex';
Â  Â  Â  Â  Â  Â  document.getElementById('balanceBtn').disabled = false;
Â  Â  Â  Â  Â  Â  const selectedRowData = jsonData[selector.value];
Â  Â  Â  Â  Â  Â  const chartLabels = headers.slice(1);
Â  Â  Â  Â  Â  Â  const chartValues = chartLabels.map(header => selectedRowData[header]);
Â  Â  Â  Â  Â  Â  originalData = { labels: [...chartLabels], values: [...chartValues], title: selectedRowData[headers[0]] };
Â  Â  Â  Â  Â  Â  const validValues = chartValues.filter(v => v >= 0);
Â  Â  Â  Â  Â  Â  if (validValues.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const total = validValues.reduce((sum, val) => sum + val, 0);
Â  Â  Â  Â  Â  Â  Â  Â  const average = total / validValues.length;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('averageDisplay').innerHTML = `ğŸ“ˆ Media Mensile: <b>${average.toFixed(2)}</b>`;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('averageDisplay').style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('balancingResults').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('balancedCalendarContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('calendarsWrapper').style.gridTemplateColumns = '1fr';
Â  Â  Â  Â  Â  Â  plotChart(originalData.title, originalData.labels, originalData.values);
Â  Â  Â  Â  Â  Â  renderSingleCalendar('calendarOriginal', "Situazione Originale", originalData.labels, originalData.values);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderSingleCalendar(elementId, title, labels, values) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById(elementId);
Â  Â  Â  Â  Â  Â  const titleEl = document.getElementById(elementId.replace('calendar', 'calendarTitle'));
Â  Â  Â  Â  Â  Â  if(titleEl) titleEl.textContent = title;
Â  Â  Â  Â  Â  Â  let firstDate = null;
Â  Â  Â  Â  Â  Â  const events = labels.map((label, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const value = values[index];
Â  Â  Â  Â  Â  Â  Â  Â  if (value > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateISO = convertDateToISO(label);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dateISO) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!firstDate) firstDate = dateISO;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { title: `ğŸ‘¤ ${value}`, start: dateISO, allDay: true, color: '#17a2b8', borderColor: '#17a2b8' };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }).filter(Boolean);
Â  Â  Â  Â  Â  Â  let calendarVar = (elementId === 'calendarOriginal') ? calendarOriginal : calendarBalanced;
Â  Â  Â  Â  Â  Â  if (calendarVar) calendarVar.destroy();
Â  Â  Â  Â  Â  Â  calendarVar = new FullCalendar.Calendar(container, {
Â  Â  Â  Â  Â  Â  Â  Â  initialDate: firstDate, initialView: 'dayGridMonth', locale: 'it',
Â  Â  Â  Â  Â  Â  Â  Â  headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
Â  Â  Â  Â  Â  Â  Â  Â  events: events, height: '100%'
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  calendarVar.render();
Â  Â  Â  Â  Â  Â  if (elementId === 'calendarOriginal') calendarOriginal = calendarVar; else calendarBalanced = calendarVar;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Funzioni di Bilanciamento e Grafici ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  // MODIFIED FUNCTION: Implements a two-stage balancing logic.
Â  Â  Â  Â  // Stage 1: Balance within each month individually.
Â  Â  Â  Â  // Stage 2: Balance across the entire period to resolve inter-month differences.
Â  Â  Â  Â  function balancePersonnel() {
Â  Â  Â  Â  Â  Â  const values = [...originalData.values];
Â  Â  Â  Â  Â  Â  const labels = [...originalData.labels];
Â  Â  Â  Â  Â  Â  const title = originalData.title;
Â  Â  Â  Â  Â  Â  const validValues = values.filter(v => v >= 0);
Â  Â  Â  Â  Â  Â  if(validValues.length === 0) return;

Â  Â  Â  Â  Â  Â  const globalAverage = validValues.reduce((sum, val) => sum + val, 0) / validValues.length;
Â  Â  Â  Â  Â  Â  let balancedValues = [...values];
Â  Â  Â  Â  Â  Â  let rawSwaps = [];

Â  Â  Â  Â  Â  Â  // --- STAGE 1: INTRA-MONTH BALANCING ---
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Group data by month ('YYYY-MM')
Â  Â  Â  Â  Â  Â  const months = {};
Â  Â  Â  Â  Â  Â  labels.forEach((label, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const isoDate = convertDateToISO(label);
Â  Â  Â  Â  Â  Â  Â  Â  if (!isoDate) return;
Â  Â  Â  Â  Â  Â  Â  Â  const monthKey = isoDate.substring(0, 7); // e.g., '2025-01'
Â  Â  Â  Â  Â  Â  Â  Â  if (!months[monthKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  months[monthKey] = [];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  months[monthKey].push({ label, value: values[index], originalIndex: index });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Loop through each month and balance it internally
Â  Â  Â  Â  Â  Â  const sortedMonthKeys = Object.keys(months).sort();
Â  Â  Â  Â  Â  Â  for (const monthKey of sortedMonthKeys) {
Â  Â  Â  Â  Â  Â  Â  Â  const monthData = months[monthKey];
Â  Â  Â  Â  Â  Â  Â  Â  const monthValues = monthData.map(d => balancedValues[d.originalIndex]);
Â  Â  Â  Â  Â  Â  Â  Â  const validMonthValues = monthValues.filter(v => v >= 0);
Â  Â  Â  Â  Â  Â  Â  Â  if (validMonthValues.length <= 1) continue;

Â  Â  Â  Â  Â  Â  Â  Â  const monthlyAverage = validMonthValues.reduce((sum, val) => sum + val, 0) / validMonthValues.length;

Â  Â  Â  Â  Â  Â  Â  Â  // Balancing loop for the current month
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < monthData.length * 2; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let diffs = monthData.map(d => balancedValues[d.originalIndex] < 0 ? -Infinity : balancedValues[d.originalIndex] - monthlyAverage);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let maxInMonthIdx = diffs.indexOf(Math.max(...diffs));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let minInMonthIdx = diffs.indexOf(Math.min(...diffs));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const globalMaxIdx = monthData[maxInMonthIdx].originalIndex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const globalMinIdx = monthData[minInMonthIdx].originalIndex;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (balancedValues[globalMaxIdx] <= Math.ceil(monthlyAverage) || balancedValues[globalMinIdx] >= Math.floor(monthlyAverage) || globalMaxIdx === globalMinIdx) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break; // This month is balanced
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  balancedValues[globalMaxIdx]--;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  balancedValues[globalMinIdx]++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rawSwaps.push({ from: labels[globalMaxIdx], to: labels[globalMinIdx] });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- STAGE 2: INTER-MONTH (GLOBAL) BALANCING ---
Â  Â  Â  Â  Â  Â  // After local optimization, balance the remaining differences globally
Â  Â  Â  Â  Â  Â  for (let i = 0; i < values.length * 2; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  let diffs = balancedValues.map(val => val < 0 ? -Infinity : val - globalAverage);
Â  Â  Â  Â  Â  Â  Â  Â  let maxIdx = diffs.indexOf(Math.max(...diffs));
Â  Â  Â  Â  Â  Â  Â  Â  let minIdx = diffs.indexOf(Math.min(...diffs));

Â  Â  Â  Â  Â  Â  Â  Â  if (balancedValues[maxIdx] <= Math.ceil(globalAverage) || balancedValues[minIdx] >= Math.floor(globalAverage) || maxIdx === minIdx) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break; // Globally balanced
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  balancedValues[maxIdx]--;
Â  Â  Â  Â  Â  Â  Â  Â  balancedValues[minIdx]++;
Â  Â  Â  Â  Â  Â  Â  Â  rawSwaps.push({ from: labels[maxIdx], to: labels[minIdx] });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Aggregate swaps and display results
Â  Â  Â  Â  Â  Â  const aggregatedSwaps = new Map();
Â  Â  Â  Â  Â  Â  rawSwaps.forEach(swap => {
Â  Â  Â  Â  Â  Â  Â  Â  const key = `${swap.from}|${swap.to}`;
Â  Â  Â  Â  Â  Â  Â  Â  aggregatedSwaps.set(key, (aggregatedSwaps.get(key) || 0) + 1);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const resultsDiv = document.getElementById('balancingResults');
Â  Â  Â  Â  Â  Â  resultsDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  let suggestionsHTML = `<h3>Proposte di Bilanciamento per "${title}"</h3><p>Media Personale/Giorno Globale: <b>${globalAverage.toFixed(2)}</b>. Clicca un suggerimento per pre-compilare le date nell'assistente.</p>`;
Â  Â  Â  Â  Â  Â  if (aggregatedSwaps.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const proposalsArray = Array.from(aggregatedSwaps, ([key, count]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const [from, to] = key.split('|');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { from, to, count };
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  proposalsArray.sort((a, b) => convertDateToISO(a.from).localeCompare(convertDateToISO(b.from)));
Â  Â  Â  Â  Â  Â  Â  Â  suggestionsHTML += '<ul>';
Â  Â  Â  Â  Â  Â  Â  Â  proposalsArray.forEach(proposal => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  suggestionsHTML += `<li onclick="selectSwapDates('${convertDateToISO(proposal.to)}', '${convertDateToISO(proposal.from)}')">Sposta <b>${proposal.count}</b> ${proposal.count > 1 ? 'persone' : 'persona'} dal <b>${proposal.from}</b> al <b>${proposal.to}</b></li>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  suggestionsHTML += '</ul>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  suggestionsHTML += "<p>Il personale Ã¨ giÃ  distribuito in modo ottimale.</p>";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  resultsDiv.innerHTML = suggestionsHTML;
Â  Â  Â  Â  Â  Â  document.getElementById('calendarsWrapper').style.gridTemplateColumns = '1fr 1fr';
Â  Â  Â  Â  Â  Â  document.getElementById('balancedCalendarContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â  plotChartComparison(title, labels, values, balancedValues);
Â  Â  Â  Â  Â  Â  renderSingleCalendar('calendarOriginal', "Situazione Originale", labels, values);
Â  Â  Â  Â  Â  Â  renderSingleCalendar('calendarBalanced', "Situazione Post-Bilanciamento", labels, balancedValues);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function selectSwapDates(isoToDate, isoFromDate) {
Â  Â  Â  Â  Â  Â  const proposalId = addProposalBlock();Â 
Â  Â  Â  Â  Â  Â  const proposal = proposals.find(p => p.id === proposalId);
Â  Â  Â  Â  Â  Â  if (proposal) {
Â  Â  Â  Â  Â  Â  Â  Â  proposal.shortageDate = isoToDate;
Â  Â  Â  Â  Â  Â  Â  Â  proposal.surplusDate = isoFromDate;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`date1-${proposalId}`).value = isoToDate;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`date2-${proposalId}`).value = isoFromDate;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById(`proposal-${proposalId}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  Â  Â  Â  }

Â  Â  Â  Â  function plotChart(title, labels, values) {
Â  Â  Â  Â  Â  Â  renderChart(`Andamento per: ${title}`, labels, [{ label: title, data: [...values], borderColor: '#1e88e5', backgroundColor: 'rgba(30, 136, 229, 0.2)', fill: true, tension: 0.2 }]);
Â  Â  Â  Â  }
Â  Â  Â  Â  function plotChartComparison(title, labels, originalValues, balancedValues) {
Â  Â  Â  Â  Â  Â  renderChart(`Confronto Bilanciamento per: ${title}`, labels, [
Â  Â  Â  Â  Â  Â  Â  Â  { label: 'Originale', data: [...originalValues], borderColor: '#dc3545', fill: false, tension: 0.2 },
Â  Â  Â  Â  Â  Â  Â  Â  { label: 'Bilanciato', data: [...balancedValues], borderColor: '#28a745', fill: false, tension: 0.2 }
Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  }
Â  Â  Â  Â  function renderChart(title, labels, datasets) {
Â  Â  Â  Â  Â  Â  const ctx = document.getElementById('myChart').getContext('2d');
Â  Â  Â  Â  Â  Â  if (myChart) myChart.destroy();
Â  Â  Â  Â  Â  Â  myChart = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: title, font: { size: 18 } } } } });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FUNZIONI PER GESTIONE PROPOSTE MULTIPLE ---
Â  Â  Â  Â  function addProposalBlock(prefill = {}) {
Â  Â  Â  Â  Â  Â  proposalCounter++;
Â  Â  Â  Â  Â  Â  const id = proposalCounter;

Â  Â  Â  Â  Â  Â  const newProposal = {
Â  Â  Â  Â  Â  Â  Â  Â  id: id,
Â  Â  Â  Â  Â  Â  Â  Â  shortageDate: prefill.shortageDate || '',
Â  Â  Â  Â  Â  Â  Â  Â  surplusDate: prefill.surplusDate || '',
Â  Â  Â  Â  Â  Â  Â  Â  freeStaffList: '',
Â  Â  Â  Â  Â  Â  Â  Â  reserveStaffList: '',
Â  Â  Â  Â  Â  Â  Â  Â  processedFreeStaff: [],
Â  Â  Â  Â  Â  Â  Â  Â  processedReserveStaff: [],
Â  Â  Â  Â  Â  Â  Â  Â  isFreeProcessed: false,
Â  Â  Â  Â  Â  Â  Â  Â  isReserveProcessed: false,
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  proposals.push(newProposal);

Â  Â  Â  Â  Â  Â  const container = document.getElementById('proposals-container');
Â  Â  Â  Â  Â  Â  const block = document.createElement('div');
Â  Â  Â  Â  Â  Â  block.className = 'proposal-block';
Â  Â  Â  Â  Â  Â  block.id = `proposal-${id}`;
Â  Â  Â  Â  Â  Â  block.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="proposal-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>Proposta di Scambio #${id}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="danger" onclick="removeProposalBlock(${id})">Rimuovi</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="swap-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="swap-area-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="date1-${id}">1. Giorno con CARENZA di personale:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="date1-${id}" value="${newProposal.shortageDate}" onchange="updateProposalData(${id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="list1-${id}" style="margin-top: 1rem;">2. Incolla qui la lista del personale LIBERO:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="list1-${id}" placeholder="Incolla qui la lista..." onchange="updateProposalData(${id})"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="processList(${id}, 1)">Elabora Lista 1</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="parsed-list-container" id="parsedList1-${id}"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="swap-area-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="date2-${id}">1. Giorno con ESUBERO di personale:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="date2-${id}" value="${newProposal.surplusDate}" onchange="updateProposalData(${id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="list2-${id}" style="margin-top: 1rem;">2. Incolla qui la lista del personale DI RISERVA:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="list2-${id}" placeholder="Incolla qui la lista..." onchange="updateProposalData(${id})"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="processList(${id}, 2)">Elabora Lista 2</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="parsed-list-container" id="parsedList2-${id}"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  container.appendChild(block);
Â  Â  Â  Â  Â  Â  return id;
Â  Â  Â  Â  }

Â  Â  Â  Â  function removeProposalBlock(id) {
Â  Â  Â  Â  Â  Â  const block = document.getElementById(`proposal-${id}`);
Â  Â  Â  Â  Â  Â  if (block) block.remove();
Â  Â  Â  Â  Â  Â  proposals = proposals.filter(p => p.id !== id);
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateProposalData(id) {
Â  Â  Â  Â  Â  Â  const proposal = proposals.find(p => p.id === id);
Â  Â  Â  Â  Â  Â  if(proposal) {
Â  Â  Â  Â  Â  Â  Â  Â  proposal.shortageDate = document.getElementById(`date1-${id}`).value;
Â  Â  Â  Â  Â  Â  Â  Â  proposal.surplusDate = document.getElementById(`date2-${id}`).value;
Â  Â  Â  Â  Â  Â  Â  Â  proposal.freeStaffList = document.getElementById(`list1-${id}`).value;
Â  Â  Â  Â  Â  Â  Â  Â  proposal.reserveStaffList = document.getElementById(`list2-${id}`).value;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function processList(id, listNumber) {
Â  Â  Â  Â  Â  Â  const proposal = proposals.find(p => p.id === id);
Â  Â  Â  Â  Â  Â  if (!proposal) return;

Â  Â  Â  Â  Â  Â  updateProposalData(id);Â 
Â  Â  Â  Â  Â  Â  const text = (listNumber === 1) ? proposal.freeStaffList : proposal.reserveStaffList;
Â  Â  Â  Â  Â  Â  if (!text) { alert(`La Lista ${listNumber} nella Proposta #${id} Ã¨ vuota.`); return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const parsedListContainer = document.getElementById(`parsedList${listNumber}-${id}`);
Â  Â  Â  Â  Â  Â  const processedData = parseEmployeeList(text);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (listNumber === 1) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  proposal.processedFreeStaff = processedData;Â 
Â  Â  Â  Â  Â  Â  Â  Â  proposal.isFreeProcessed = true;Â 
Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  proposal.processedReserveStaff = processedData;
Â  Â  Â  Â  Â  Â  Â  Â  proposal.isReserveProcessed = true;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (processedData.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  parsedListContainer.innerHTML = `<p>Nessun collaboratore valido trovato.</p>`; return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const presto = processedData.filter(e => e.shiftType === 'Presto');
Â  Â  Â  Â  Â  Â  const medio = processedData.filter(e => e.shiftType === 'Medio');
Â  Â  Â  Â  Â  Â  const tardi = processedData.filter(e => e.shiftType === 'Tardi');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let html = `<h4>Trovati ${processedData.length} collaboratori:</h4>`;
Â  Â  Â  Â  Â  Â  if (presto.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  html += '<h5>Turni Presto â˜€ï¸</h5><ul>';
Â  Â  Â  Â  Â  Â  Â  Â  presto.forEach(emp => { html += `<li>${emp.name} (ID: ${emp.id})</li>`; });
Â  Â  Â  Â  Â  Â  Â  Â  html += '</ul>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (medio.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  html += '<h5>Turni Medio ğŸ•›</h5><ul>';
Â  Â  Â  Â  Â  Â  Â  Â  medio.forEach(emp => { html += `<li>${emp.name} (ID: ${emp.id})</li>`; });
Â  Â  Â  Â  Â  Â  Â  Â  html += '</ul>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (tardi.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  html += '<h5>Turni Tardi ğŸŒ™</h5><ul>';
Â  Â  Â  Â  Â  Â  Â  Â  tardi.forEach(emp => { html += `<li>${emp.name} (ID: ${emp.id})</li>`; });
Â  Â  Â  Â  Â  Â  Â  Â  html += '</ul>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  parsedListContainer.innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  function parseEmployeeList(text) {
Â  Â  Â  Â  Â  Â  const employees = [];
Â  Â  Â  Â  Â  Â  const lines = text.split('\n').filter(line => line.trim() !== '');
Â  Â  Â  Â  Â  Â  const idRegex = /\b(\d{6})\b/;
Â  Â  Â  Â  Â  Â  lines.forEach(line => {
Â  Â  Â  Â  Â  Â  Â  Â  const match = line.match(idRegex);
Â  Â  Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const id = match[1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const parts = line.substring(0, match.index).split(/\s+/).filter(p => p);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let name = "Nome non trovato";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (parts.length >= 2) name = parts.slice(-2).join(' ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let shiftType = 'Medio'; // Default
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (line.includes('FrÃ¼h') || line.includes('Presto')) shiftType = 'Presto';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (line.includes('SpÃ¤t') || line.includes('Tardi')) shiftType = 'Tardi';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  employees.push({ id, name, shiftType });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return employees;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function findAllSwapsAndGenerateEmails() {
Â  Â  Â  Â  Â  Â  const resultsDiv = document.getElementById('swapResults');
Â  Â  Â  Â  Â  Â  resultsDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  resultsDiv.innerHTML = '';
Â  Â  Â  Â  Â  Â  updateAllProposalsData();

Â  Â  Â  Â  Â  Â  const consolidatedSwaps = new Map();
Â  Â  Â  Â  Â  Â  let hasUnprocessedLists = false;

Â  Â  Â  Â  Â  Â  for (const proposal of proposals) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!proposal.isFreeProcessed || !proposal.isReserveProcessed) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hasUnprocessedLists = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!proposal.shortageDate || !proposal.surplusDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const idsInReserveList = new Set(proposal.processedReserveStaff.map(emp => emp.id));
Â  Â  Â  Â  Â  Â  Â  Â  const commonEmployees = proposal.processedFreeStaff.filter(emp => idsInReserveList.has(emp.id));

Â  Â  Â  Â  Â  Â  Â  Â  for (const emp of commonEmployees) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const name = emp.name.split(' ').map(n => n.charAt(0).toUpperCase() + n.slice(1).toLowerCase()).join(' ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const swapInfo = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  proposalId: proposal.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dateToWork: proposal.shortageDate,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dateToFree: proposal.surplusDate
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (consolidatedSwaps.has(emp.id)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  consolidatedSwaps.get(emp.id).swaps.push(swapInfo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  consolidatedSwaps.set(emp.id, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: emp.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  swaps: [swapInfo]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (hasUnprocessedLists) {
Â  Â  Â  Â  Â  Â  Â  Â  resultsDiv.innerHTML = `<p style="color: var(--danger-color);">Attenzione: Alcune liste non sono state elaborate. Clicca "Elabora Lista" per ogni lista prima di continuare.</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (consolidatedSwaps.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  let html = `<h4>Risultato: ${consolidatedSwaps.size} Collaboratori Trovati con Proposte di Scambio</h4><ul>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  consolidatedSwaps.forEach(employeeData => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const monthObj = new Date(employeeData.swaps[0].dateToWork);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const monthName = monthObj.toLocaleString('it-IT', { month: 'long' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const primoNome = employeeData.name.split(' ')[1];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let body = `Buongiorno ${primoNome},\n\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â `Stiamo allestendo la distribuzione di ${monthName} e, per poter ottimizzare la pianificazione fino a fine anno, vorremmo chiederti se potessi effettuare i seguenti cambi di turni:\n\n`;
Â  Â Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  employeeData.swaps.forEach((swap, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateObjToWork = new Date(swap.dateToWork);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateObjToFree = new Date(swap.dateToFree);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formattedDateToWork = dateObjToWork.toLocaleDateString('it-IT', { day: 'numeric', month: 'long' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formattedDateToFree = dateObjToFree.toLocaleDateString('it-IT', { day: 'numeric', month: 'long' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body += `- Proposta #${index + 1}: Fare libero il ${formattedDateToFree} in cambio di lavorare il giorno ${formattedDateToWork}\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body += `\nGrazie mille per farci sapere (puoi rispondere direttamente a questa mail).\n\nBuona giornata\n\nSaluti\nRipartizione del Personale \nP-O-BP-ZFR-MSD-EIN\nFerrovie Federali Svizzere â€“ FFS\nProduzione ferroviaria â€“ Condotta dei treni e manovra\n6500 BellinzonaÂ  `;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const subject = `Proposta cambio turni - ${employeeData.name}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${employeeData.name} (ID: ${employeeData.id}) - ${employeeData.swaps.length} proposte</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="${mailtoLink}" style="text-decoration: none;"><button type="button">Invia Email Unica</button></a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </li>`;
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  html += '</ul>';
Â  Â  Â  Â  Â  Â  Â  Â  resultsDiv.innerHTML += html;Â 
Â  Â  Â  Â  Â  Â  } else if (!hasUnprocessedLists) {
Â  Â  Â  Â  Â  Â  Â  Â  resultsDiv.innerHTML = '<h4 style="text-align: center;">Nessun collaboratore in comune trovato per le proposte definite.</h4>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateAllProposalsData() {
Â  Â  Â  Â  Â  Â  for(const proposal of proposals) {
Â  Â  Â  Â  Â  Â  Â  Â  updateProposalData(proposal.id);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Funzione per inizializzare l'app
Â  Â  Â  Â  function init() {
Â  Â  Â  Â  Â  Â  addProposalBlock(); // Aggiunge il primo blocco di proposta all'avvio
Â  Â  Â  Â  }

Â  Â  Â  Â  // Avvia l'applicazione
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', init);

Â  Â  </script>
</body>
</html> allora in questo codice ?
