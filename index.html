<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisi e Gestione Personale</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <style>
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1e88e5;
            --accent-color: #5c6bc0;
            --success-color: #28a745; 
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-gray: #f4f7f6;
            --dark-gray: #333;
            --white-color: #ffffff;
            --border-color: #ddd;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 2rem; background-color: var(--light-gray); color: var(--dark-gray);
            display: flex; flex-direction: column; align-items: center;
        }
        h1, h2, h3, h4, h5 { color: var(--primary-color); font-weight: 600; }
        .container {
            background: var(--white-color); padding: 2rem; border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); width: 95%; max-width: 1400px; margin-bottom: 2rem;
        }
        
        /* Dashboard Controls */
        #controls {
            display: flex; gap: 1.5rem; align-items: center; margin-bottom: 1rem;
            flex-wrap: wrap; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);
        }
        #averageDisplay {
            margin-left: auto; padding: 0.7rem 1rem; background-color: #eef7ff;
            border: 2px solid var(--info-color); border-radius: 8px; font-size: 16px;
            font-weight: 500; color: var(--primary-color); display: none;
        }
        
        /* Inputs & Buttons */
        input, select, button, textarea {
            font-size: 16px; padding: 0.7rem 1rem; border-radius: 8px;
            border: 1px solid #ccc; font-family: inherit; transition: all 0.3s ease;
        }
        input[type="file"]::file-selector-button {
            background-color: var(--secondary-color); color: var(--white-color); border: none;
            padding: 0.7rem 1rem; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease;
        }
        input[type="file"]::file-selector-button:hover { background-color: var(--primary-color); }
        button { background-color: var(--secondary-color); color: var(--white-color); border: none; cursor: pointer; }
        button:hover { background-color: var(--primary-color); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: #a8001b; }
        button:disabled { background-color: #9e9e9e; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* Dashboard Views */
        #dashboard { display: flex; flex-direction: column; gap: 2rem; width: 100%; margin-top: 1rem; }
        #chartContainer { height: 400px; width: 100%; }
        #calendarsWrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .calendar-container { height: 480px; }
        .calendar-container h3 { text-align: center; margin-top: 0; margin-bottom: 10px; }
        .calendar-instance { height: calc(100% - 30px); }

        /* Results Areas */
        #balancingResults, #swapResults { margin-top: 2rem; padding: 1.5rem; background-color: #e3f2fd; border-left: 6px solid var(--secondary-color); border-radius: 8px; }
        #balancingResults ul, #swapResults ul { list-style-type: none; padding-left: 0; }
        #balancingResults li, #swapResults li { padding: 12px; border-radius: 6px; margin-bottom: 8px; background-color: #fff; border: 1px solid #90caf9; display: flex; justify-content: space-between; align-items: center;}
        #balancingResults li:hover { background-color: #e3f2fd; }

        /* Swap Assistant Specifics */
        #swapHelper { border: 2px solid var(--accent-color); padding: 1.5rem; border-radius: 8px; scroll-margin-top: 20px; }
        .proposal-block {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            background-color: #fafafa;
        }
        .proposal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
        .swap-area { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .swap-area-col label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .swap-area-col input[type="date"], .swap-area-col textarea { width: calc(100% - 2.2rem); margin-bottom: 0.5rem; }
        .swap-area-col textarea { height: 150px; resize: vertical; }
        .swap-area-col button { width: 100%; margin-top: 0.5rem; }
        .parsed-list-container { border: 1px solid var(--border-color); margin-top: 1rem; padding: 0.5rem 1rem; border-radius: 5px; background-color: #fff; max-height: 200px; overflow-y: auto; }
        .parsed-list-container h5 { margin: 10px 0 5px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        .parsed-list-container ul { list-style-type: none; padding-left: 5px; margin-top: 5px; }
        
        /* Data Table */
        #tableContainer { margin-top: 2.5rem; width: 100%; overflow-x: auto; }
        #dataTable { width: 100%; border-collapse: collapse; font-size: 14px; }
        #dataTable caption { caption-side: bottom; text-align: right; font-size: 12px; color: #666; padding-top: 10px; }
        #dataTable th, #dataTable td { border: 1px solid var(--border-color); padding: 10px; text-align: left; white-space: nowrap; }
        hr { border: none; border-top: 1px solid #ccc; margin: 2rem 0; }
        
        @media (max-width: 1200px) { #calendarsWrapper { grid-template-columns: 1fr; } .swap-area { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>Dashboard Analisi Personale üìä</h1>
        <div id="controls">
            <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" onchange="handleFile()">
            
            <label for="rowSelector">Scegli una voce da analizzare:</label>
            <select id="rowSelector" onchange="plotSelectedData()" disabled></select>
            
            <button id="balanceBtn" onclick="balancePersonnel()" disabled>Suggerisci Bilanciamento</button>
            
            <div id="averageDisplay"></div>
        </div>
        
        <div id="dashboard" style="display: none;">
            <div id="chartContainer"><canvas id="myChart"></canvas></div>
            <div id="calendarsWrapper">
                <div class="calendar-container" id="originalCalendarContainer">
                    <h3 id="originalCalendarTitle"></h3>
                    <div id="calendarOriginal" class="calendar-instance"></div>
                </div>
                <div class="calendar-container" id="balancedCalendarContainer" style="display: none;">
                    <h3 id="balancedCalendarTitle"></h3>
                    <div id="calendarBalanced" class="calendar-instance"></div>
                </div>
            </div>
            <div id="balancingResults" style="display: none;"></div>
        </div>
    </div>

    <div class="container" id="swapHelper">
        <h2>Assistente Scambio Turni üõ†Ô∏è</h2>
        <p>Aggiungi una o pi√π proposte di scambio. 
           <br><strong>Regola Lista 1 (Libero):</strong> Vengono esclusi collaboratori che hanno orari nella riga (non totalmente liberi).
           <br><strong>Regola Lista 2 (Riserva):</strong> Vengono esclusi collaboratori con meno di 12 ore di riposo.</p>
        
        <div id="proposals-container"></div>

        <button onclick="addProposalBlock()" style="margin-top: 1.5rem;">+ Aggiungi Proposta di Scambio</button>
        <hr>
        <button id="findCommonBtn" onclick="findAllSwapsAndGenerateEmails()" style="width: 100%; padding: 1rem; font-size: 1.1rem; background-color: var(--primary-color);" >Analizza TUTTE le proposte e Trova Collaboratori Comuni</button>
        <div id="swapResults" style="display: none;"></div>
    </div>
    
    <div class="container" id="tableContainer" style="display: none;">
        <h2>Dettaglio Dati Importati</h2>
        <table id="dataTable"></table>
    </div>

    <script>
        // --- Variabili Globali ---
        let myChart = null, calendarOriginal = null, calendarBalanced = null;
        let jsonData = [], headers = [], originalData = {};
        let proposals = []; 
        let proposalCounter = 0; 
        const displayLimit = 200;

        // --- 1. Funzioni Gestione Dashboard e Excel ---
        function convertDateToISO(dateStr) {
            const parts = String(dateStr).split('.');
            if (parts.length !== 3) return null;
            return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        }

        async function handleFile() {
            const fileInput = document.getElementById('excelFile');
            if (!fileInput.files[0]) return;
            const data = await fileInput.files[0].arrayBuffer();
            const workbook = XLSX.read(data);
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const matrix = XLSX.utils.sheet_to_json(worksheet, { header: 1, skipHidden: true, defval: 0 });
            let headerRowIndex = matrix.findIndex(row => row.length > 2);
            if (headerRowIndex === -1) { alert("Intestazione non trovata."); return; }
            const headerRow = matrix[headerRowIndex];
            headers = headerRow.filter(h => h);
            jsonData = matrix.slice(headerRowIndex + 1).map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    const rawValue = row[index];
                    let cleanValue = (typeof rawValue === 'number' || (typeof rawValue === 'string' && rawValue.trim() !== '')) ? parseFloat(rawValue) : 0;
                    if (isNaN(cleanValue) || cleanValue < 0) cleanValue = 0;
                    obj[header] = index === 0 ? rawValue : cleanValue;
                });
                return obj;
            }).filter(obj => obj[headers[0]]);
            const selector = document.getElementById('rowSelector');
            selector.innerHTML = '<option value="">-- Seleziona --</option>';
            jsonData.slice(0, displayLimit).forEach((row, index) => {
                selector.appendChild(new Option(row[headers[0]], index));
            });
            if (jsonData.length > displayLimit) {
                const option = new Option(`E ${jsonData.length - displayLimit} altre voci non mostrate...`, '');
                option.disabled = true;
                selector.appendChild(option);
            }
            selector.disabled = false;
            document.getElementById('balanceBtn').disabled = true;
            document.getElementById('tableContainer').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('balancingResults').style.display = 'none';
            document.getElementById('averageDisplay').style.display = 'none';
            if (myChart) myChart.destroy();
            if (calendarOriginal) calendarOriginal.destroy();
            if (calendarBalanced) calendarBalanced.destroy();
            displayTable();
        }

        function displayTable() {
            const table = document.getElementById('dataTable');
            table.innerHTML = '';
            const thead = table.createTHead().insertRow();
            headers.forEach(text => thead.appendChild(document.createElement('th')).textContent = text);
            const tbody = table.createTBody();
            jsonData.slice(0, displayLimit).forEach(dataRow => {
                const row = tbody.insertRow();
                headers.forEach(header => row.insertCell().textContent = dataRow[header] !== undefined ? dataRow[header] : '');
            });
        }

        function plotSelectedData() {
            const selector = document.getElementById('rowSelector');
            if (!selector.value) return;
            document.getElementById('dashboard').style.display = 'flex';
            document.getElementById('balanceBtn').disabled = false;
            const selectedRowData = jsonData[selector.value];
            const chartLabels = headers.slice(1);
            const chartValues = chartLabels.map(header => selectedRowData[header]);
            originalData = { labels: [...chartLabels], values: [...chartValues], title: selectedRowData[headers[0]] };
            
            // Calcolo Media
            const validValues = chartValues.filter(v => v >= 0);
            if (validValues.length > 0) {
                const total = validValues.reduce((sum, val) => sum + val, 0);
                const average = total / validValues.length;
                document.getElementById('averageDisplay').innerHTML = `üìà Media Mensile: <b>${average.toFixed(2)}</b>`;
                document.getElementById('averageDisplay').style.display = 'block';
            }

            plotChart(originalData.title, originalData.labels, originalData.values);
            renderSingleCalendar('calendarOriginal', "Situazione Originale", originalData.labels, originalData.values);
        }

        function renderSingleCalendar(elementId, title, labels, values) {
            const container = document.getElementById(elementId);
            const titleEl = document.getElementById(elementId.replace('calendar', 'calendarTitle'));
            if(titleEl) titleEl.textContent = title;
            let firstDate = null;
            const events = labels.map((label, index) => {
                const value = values[index];
                if (value > 0) {
                    const dateISO = convertDateToISO(label);
                    if (dateISO) {
                        if (!firstDate) firstDate = dateISO;
                        return { title: `üë§ ${value}`, start: dateISO, allDay: true, color: '#17a2b8', borderColor: '#17a2b8' };
                    }
                }
                return null;
            }).filter(Boolean);
            let calendarVar = (elementId === 'calendarOriginal') ? calendarOriginal : calendarBalanced;
            if (calendarVar) calendarVar.destroy();
            calendarVar = new FullCalendar.Calendar(container, {
                initialDate: firstDate, initialView: 'dayGridMonth', locale: 'it',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                events: events, height: '100%'
            });
            calendarVar.render();
            if (elementId === 'calendarOriginal') calendarOriginal = calendarVar; else calendarBalanced = calendarVar;
        }

        function plotChart(title, labels, values) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: title, data: [...values], borderColor: '#1e88e5', backgroundColor: 'rgba(30, 136, 229, 0.2)', fill: true, tension: 0.2 }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function balancePersonnel() {
            // Funzione semplificata di bilanciamento
            const values = [...originalData.values];
            const labels = [...originalData.labels];
            const validValues = values.filter(v => v >= 0);
            if(validValues.length === 0) return;
            const avg = Math.round(validValues.reduce((a,b)=>a+b,0)/validValues.length);
            
            const balancedValues = values.map(v => v < 0 ? v : avg);
            
            document.getElementById('balancedCalendarContainer').style.display = 'block';
            document.getElementById('calendarsWrapper').style.gridTemplateColumns = '1fr 1fr';
            renderSingleCalendar('calendarBalanced', "Situazione Ideale (Simulata)", labels, balancedValues);
            
            const resultsDiv = document.getElementById('balancingResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `<p>Simulazione: L'organico medio ideale √® di circa <b>${avg}</b> persone al giorno.</p>`;
        }

        // --- 2. Funzioni Assistente Scambio Turni ---

        function addProposalBlock(prefill = {}) {
            proposalCounter++;
            const id = proposalCounter;
            const newProposal = {
                id: id,
                shortageDate: prefill.shortageDate || '',
                surplusDate: prefill.surplusDate || '',
                freeStaffList: '',
                reserveStaffList: '',
                processedFreeStaff: [],
                processedReserveStaff: [],
                isFreeProcessed: false,
                isReserveProcessed: false,
            };
            proposals.push(newProposal);

            const container = document.getElementById('proposals-container');
            const block = document.createElement('div');
            block.className = 'proposal-block';
            block.id = `proposal-${id}`;
            block.innerHTML = `
                <div class="proposal-header">
                    <h4>Proposta di Scambio #${id}</h4>
                    <button class="danger" onclick="removeProposalBlock(${id})">Rimuovi</button>
                </div>
                <div class="swap-area">
                    <div class="swap-area-col">
                        <label for="date1-${id}">1. Giorno con CARENZA di personale:</label>
                        <input type="date" id="date1-${id}" value="${newProposal.shortageDate}" onchange="updateProposalData(${id})">
                        <label for="list1-${id}" style="margin-top: 1rem;">2. Incolla qui la lista del personale LIBERO:</label>
                        <textarea id="list1-${id}" placeholder="Incolla lista..." onchange="updateProposalData(${id})"></textarea>
                        <button onclick="processList(${id}, 1)">Elabora Lista 1 (Strict Free)</button>
                        <div class="parsed-list-container" id="parsedList1-${id}"></div>
                    </div>
                    <div class="swap-area-col">
                        <label for="date2-${id}">1. Giorno con ESUBERO di personale:</label>
                        <input type="date" id="date2-${id}" value="${newProposal.surplusDate}" onchange="updateProposalData(${id})">
                        <label for="list2-${id}" style="margin-top: 1rem;">2. Incolla qui la lista del personale DI RISERVA:</label>
                        <textarea id="list2-${id}" placeholder="Incolla lista..." onchange="updateProposalData(${id})"></textarea>
                        <button onclick="processList(${id}, 2)">Elabora Lista 2 (Controllo 12h)</button>
                        <div class="parsed-list-container" id="parsedList2-${id}"></div>
                    </div>
                </div>
            `;
            container.appendChild(block);
            return id;
        }

        function removeProposalBlock(id) {
            const block = document.getElementById(`proposal-${id}`);
            if (block) block.remove();
            proposals = proposals.filter(p => p.id !== id);
        }

        function updateProposalData(id) {
            const proposal = proposals.find(p => p.id === id);
            if(proposal) {
                proposal.shortageDate = document.getElementById(`date1-${id}`).value;
                proposal.surplusDate = document.getElementById(`date2-${id}`).value;
                proposal.freeStaffList = document.getElementById(`list1-${id}`).value;
                proposal.reserveStaffList = document.getElementById(`list2-${id}`).value;
            }
        }

        function processList(id, listNumber) {
            const proposal = proposals.find(p => p.id === id);
            if (!proposal) return;

            updateProposalData(id); 
            const text = (listNumber === 1) ? proposal.freeStaffList : proposal.reserveStaffList;
            if (!text) { alert(`La Lista ${listNumber} √® vuota.`); return; }
            
            const parsedListContainer = document.getElementById(`parsedList${listNumber}-${id}`);
            
            // CONFIGURAZIONE REGOLE:
            // Lista 1 (Libero): strictFree = true. Se ha orari, viene SCARTATO.
            const strictFree = (listNumber === 1);
            // Lista 2 (Riserva): checkRestRule = true. Se ha orari, controlla che ci siano 12 ore di pausa.
            const checkRest = (listNumber === 2);

            const processedData = parseEmployeeList(text, checkRest, strictFree);
            
            if (listNumber === 1) { 
                proposal.processedFreeStaff = processedData; 
                proposal.isFreeProcessed = true; 
            } else { 
                proposal.processedReserveStaff = processedData;
                proposal.isReserveProcessed = true;
            }

            if (processedData.length === 0) {
                let msg = "Nessun collaboratore valido trovato.";
                if (strictFree) msg += " (Scartati collaboratori con orari presenti)";
                if (checkRest) msg += " (Scartati collaboratori senza 12h di riposo)";
                parsedListContainer.innerHTML = `<p>${msg}</p>`; return;
            }

            const presto = processedData.filter(e => e.shiftType === 'Presto');
            const medio = processedData.filter(e => e.shiftType === 'Medio');
            const tardi = processedData.filter(e => e.shiftType === 'Tardi');
            
            let html = `<h4>Trovati ${processedData.length} collaboratori idonei:</h4>`;
            
            const printItem = (emp) => {
                let info = `<li><b>${emp.name}</b> (${emp.id})`;
                if (emp.restGap) {
                    info += ` <span style="font-size:0.85em; color: green; margin-left:5px;">‚úÖ Riposo: ${emp.restGap}</span>`;
                }
                info += `</li>`;
                return info;
            };

            if (presto.length > 0) {
                html += '<h5>Turni Presto ‚òÄÔ∏è</h5><ul>';
                presto.forEach(emp => { html += printItem(emp); });
                html += '</ul>';
            }
            if (medio.length > 0) {
                html += '<h5>Turni Medio üïõ</h5><ul>';
                medio.forEach(emp => { html += printItem(emp); });
                html += '</ul>';
            }
            if (tardi.length > 0) {
                html += '<h5>Turni Tardi üåô</h5><ul>';
                tardi.forEach(emp => { html += printItem(emp); });
                html += '</ul>';
            }
            parsedListContainer.innerHTML = html;
        }

        // --- FUNZIONE DI PARSING (Doppia Logica: StrictFree & 12hRule) ---
        function parseEmployeeList(text, checkRestRule = false, excludeIfHasTimes = false) {
            const employees = [];
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const idRegex = /\b(\d{6})\b/;

            lines.forEach(line => {
                const matchId = line.match(idRegex);
                
                if (matchId) {
                    const id = matchId[1];
                    
                    // Estrazione Nome
                    const parts = line.substring(0, matchId.index).split(/\s+/).filter(p => p);
                    let name = "Nome sconosciuto";
                    if (parts.length >= 2) name = parts.slice(-2).join(' ');
                    else if (parts.length === 1) name = parts[0];

                    // Estrazione Tipo Turno
                    let shiftType = 'Medio'; 
                    const lowerLine = line.toLowerCase();
                    if (lowerLine.includes('fr√ºh') || lowerLine.includes('presto')) shiftType = 'Presto';
                    else if (lowerLine.includes('sp√§t') || lowerLine.includes('tardi')) shiftType = 'Tardi';

                    let isEligible = true; // Default SI
                    let restGapStr = "";

                    // Cerca tutti gli orari (formato HH:MM)
                    const allTimes = [...line.matchAll(/(\d{1,2}:\d{2})/g)].map(m => m[1]);

                    // --- LOGICA LISTA 1 (PERSONALE LIBERO) ---
                    if (excludeIfHasTimes) {
                        // Se ci sono orari (almeno 2), significa che non √® libero al 100% -> SCARTARE
                        if (allTimes.length >= 2) {
                            isEligible = false;
                        }
                    }

                    // --- LOGICA LISTA 2 (RISERVA - 12 ORE) ---
                    else if (checkRestRule) {
                        // Se ci sono orari, controlla la pausa
                        if (allTimes.length >= 2) {
                            const prevEndTime = allTimes[0]; // es. 17:10
                            const nextStartTime = allTimes[1]; // es. 04:38

                            const [h1, m1] = prevEndTime.split(':').map(Number);
                            const [h2, m2] = nextStartTime.split(':').map(Number);

                            const min1 = h1 * 60 + m1; 
                            const min2 = h2 * 60 + m2; 

                            // Se inizio (min2) < fine (min1), siamo nel giorno dopo (+1440 min)
                            let minutes2Adjusted = min2;
                            if (min2 < min1) {
                                minutes2Adjusted += 1440; 
                            }

                            const diffMinutes = minutes2Adjusted - min1;
                            
                            // Se < 720 minuti (12h) -> SCARTARE
                            if (diffMinutes < 720) {
                                isEligible = false; 
                            } else {
                                const h = Math.floor(diffMinutes / 60);
                                const m = diffMinutes % 60;
                                restGapStr = `${h}h ${m}m`;
                            }
                        } 
                        // Se NON ci sono orari, rimane isEligible = true (default)
                    }

                    if (isEligible) {
                        employees.push({ id, name, shiftType, restGap: restGapStr });
                    }
                }
            });
            return employees;
        }

        function findAllSwapsAndGenerateEmails() {
            const resultsDiv = document.getElementById('swapResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            
            proposals.forEach(p => updateProposalData(p.id));

            const consolidatedSwaps = new Map();
            let hasUnprocessedLists = false;

            for (const proposal of proposals) {
                if (!proposal.isFreeProcessed || !proposal.isReserveProcessed) {
                    hasUnprocessedLists = true;
                    continue; 
                }
                if (!proposal.shortageDate || !proposal.surplusDate) continue;

                const idsInReserveList = new Set(proposal.processedReserveStaff.map(emp => emp.id));
                const commonEmployees = proposal.processedFreeStaff.filter(emp => idsInReserveList.has(emp.id));

                for (const emp of commonEmployees) {
                    const name = emp.name.split(' ').map(n => n.charAt(0).toUpperCase() + n.slice(1).toLowerCase()).join(' ');
                    const swapInfo = {
                        proposalId: proposal.id,
                        dateToWork: proposal.shortageDate,
                        dateToFree: proposal.surplusDate
                    };

                    if (consolidatedSwaps.has(emp.id)) {
                        consolidatedSwaps.get(emp.id).swaps.push(swapInfo);
                    } else {
                        consolidatedSwaps.set(emp.id, {
                            name: name,
                            id: emp.id,
                            swaps: [swapInfo]
                        });
                    }
                }
            }

            if (hasUnprocessedLists) {
                resultsDiv.innerHTML = `<p style="color: var(--danger-color);">Attenzione: Alcune liste non sono state elaborate. Clicca "Elabora Lista" per ogni blocco.</p>`;
            }
            
            if (consolidatedSwaps.size > 0) {
                let html = `<h4>Risultato: ${consolidatedSwaps.size} Collaboratori Trovati</h4><ul>`;
                consolidatedSwaps.forEach(employeeData => {
                    const monthObj = new Date(employeeData.swaps[0].dateToWork);
                    const monthName = monthObj.toLocaleString('it-IT', { month: 'long' });
                    const primoNome = employeeData.name.split(' ')[1] || employeeData.name.split(' ')[0];

                    let body = `Buongiorno ${primoNome},\n\n` +
                             `Stiamo allestendo la distribuzione di ${monthName} e, per poter ottimizzare la pianificazione fino a fine anno, vorremmo chiederti se potessi effettuare i seguenti cambi di turni:\n\n`;

                    employeeData.swaps.forEach((swap, index) => {
                        const dWork = new Date(swap.dateToWork).toLocaleDateString('it-IT', { day: 'numeric', month: 'long' });
                        const dFree = new Date(swap.dateToFree).toLocaleDateString('it-IT', { day: 'numeric', month: 'long' });
                        body += `- Proposta #${index + 1}: Fare libero il ${dFree} in cambio di lavorare il giorno ${dWork}\n`;
                    });

                    body += `\nGrazie mille per farci sapere (puoi rispondere direttamente a questa mail).\n\nBuona giornata\n\nSaluti\nRipartizione del Personale \nP-O-BP-ZFR-MSD-EIN\nFerrovie Federali Svizzere ‚Äì FFS\nProduzione ferroviaria ‚Äì Condotta dei treni e manovra\n6500 Bellinzona`;

                    const subject = `Proposta cambio turni - ${employeeData.name}`;
                    const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    
                    html += `<li>
                                <span><b>${employeeData.name}</b> (${employeeData.id}) - ${employeeData.swaps.length} cambi richiesti</span>
                                <a href="${mailtoLink}" style="text-decoration: none;"><button type="button">Invia Email Unica ‚úâÔ∏è</button></a>
                             </li>`;
                });
                html += '</ul>';
                resultsDiv.innerHTML += html; 
            } else if (!hasUnprocessedLists) {
                resultsDiv.innerHTML = '<h4 style="text-align: center;">Nessun collaboratore compatibile trovato tra le liste.</h4>';
            }
        }
        
        function init() { 
            addProposalBlock(); 
        }
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
